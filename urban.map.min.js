(function(){var t,n;n=function(t){throw"Urban Map Error : "+t};t=function(){function t(t){var e,o,i,a,r,l,s,u;a=this;if(t==null){t={}}i=["geoJson","csv","colors","countyID","displayVariable","renderTo"];for(l=0,s=i.length;l<s;l++){o=i[l];if(e=t[o]){a[o]=e}else{n('"'+o+'" not provided to Map.')}}this.tooltip=(u=t.tooltip)!=null?u:{formatter:function(){},opacity:0};if(r=Urban.cache[t.geoJson]){a.countyJson=r;a.loadCSV(a.csv,function(){a.render();return a.update(a.displayVariable)})}else{d3.json(t.geoJson,function(n,e){Urban.cache[t.geoJson]=e;a.countyJson=e;return a.loadCSV(a.csv,function(){a.render();return a.update(a.displayVariable)})})}}t.prototype.loadCSV=function(t,e){var o,i,a;a=this;i=a.countyID;o=Urban.cache;if(o[t]){a.data=o[t];e()}else{d3.csv(t,function(t,o){var r,l,s,u;a.data=r={};for(s=0,u=o.length;s<u;s++){l=o[s];if(!(i in l)){n(""+i+" not in csv!")}r[l[i]]=l}return e()})}return a};t.prototype.render=function(){var t,n,e,o,i,a,r,l,s,u,d,c,p;l=this;p=this.width=1011;e=this.hieght=588;a=d3.geo.albersUsa().scale(p).translate([p/2,e/2]);i=d3.geo.path().projection(a);r=d3.select(this.renderTo);u=r.html("").append("svg").attr({"class":"urban-map",preserveAspectRatio:"xMinYMin slice",viewBox:"0 0 "+p+" "+e}).append("g");this.legend=u.append("g").attr({"class":"urban-map-legend"});c=topojson.feature(this.countyJson,this.countyJson.objects.counties).features;s=topojson.mesh(this.countyJson,this.countyJson.objects.states,function(t,n){return t!==n});d3.select("div.urban-map-tooltip").remove();d=d3.select("body").append("div").attr("class","urban-map-tooltip").style({display:"block",position:"absolute",opacity:0});d3.select("body").on("mousemove",function(){var t,n,e,o;o=[d3.event.pageX,d3.event.pageY],n=o[0],e=o[1];d=d3.select("div.urban-map-tooltip");t=d.node().getBoundingClientRect();return d.style({top:""+(e-t.height-10)+"px",left:""+(n-t.width/2)+"px"})});t=l.data;n=l.tooltip.formatter;o=l.tooltip.opacity;this.counties=u.append("g").selectAll("path").data(c).enter().append("path").attr({"class":"urban-map-counties",id:function(t){return t.id},d:i}).on("mouseover",function(){var e;d=d3.select("div.urban-map-tooltip");e=this.id in t?t[this.id]:{};return d.html(n.call(e)).transition().duration(100).style({opacity:o})}).on("mouseout",function(){d=d3.select("div.urban-map-tooltip");return d.transition().duration(100).style({opacity:0})});u.append("path").datum(s).attr({"class":"urban-map-states",d:i}).style({fill:"none"});return l};t.prototype.update=function(t){var e,o,i,a,r,l,s,u,d,c,p,h,f,b,v,g,y,m,w,J,x,j,M,U,V,A;h=this;i=this.bins=(b=(v=t.breaks)!=null?v:this.bins)!=null?b:n("No bins provided!");p=(w=t.name)!=null?w:n("No variable name provided!");s=this.colors=(J=t.colors)!=null?J:this.colors;c=this.fmt=(x=(j=(M=t.legend)!=null?M.formatter:void 0)!=null?j:this.fmt)!=null?x:function(){return this.value};o=this.binWidth=(U=(V=(A=t.legend)!=null?A.binWidth:void 0)!=null?V:this.binWidth)!=null?U:40;u=this.enable=(g=(y=(m=t.legend)!=null?m.enabled:void 0)!=null?y:this.enabled)!=null?g:true;e=i.length;a=s.length;if(e>a){throw""+(e-a)+" more bins than colors!"}if(e<a){throw""+(a-e)+" more colors than bins!"}l=d3.scale.threshold().domain(i).range(s);this.legend.empty();if(u){r=(this.width-o*i.length)/2;this.legend.selectAll("rect").data(i).enter().append("rect").attr({width:o,height:o*.5,x:function(t,n){return r+n*o},y:50}).style({fill:function(t){return l(t*(t>0?.99:1.01))}});this.legend.selectAll("text").data(i.slice(0,-1)).enter().append("text").text(function(t){return c.call({value:t})}).attr({y:40,x:function(t,n){return r+(n+1)*o-o/3}})}d=function(t){var n,e;return l((n=(e=h.data[t.id])!=null?e[p]:void 0)!=null?n:"#aaa")};if(f=t.transition){this.counties.transition().duration(Math.abs(f)).attr("fill",d)}else{this.counties.attr("fill",d)}return h};return t}();(function(){var n;n=n||{};if(n.cache==null){n.cache={}}n.Map=t;return window.Urban=n})()}).call(this);